<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking de Competidores</title>
    <!-- Inclui o Tailwind CSS do CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração do Tailwind para a fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="font-inter bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl w-full bg-white shadow-lg rounded-xl p-6 sm:p-8 lg:p-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-indigo-700">Ranking de Competidores</h1>

        <!-- Botões de Ordenação -->
        <div class="flex flex-wrap justify-center gap-4 mb-6">
            <button id="sort-position" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                Ordenar por Posição
            </button>
            <button id="sort-host" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                Ordenar por Host
            </button>
            <button id="sort-price" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                Ordenar por Preço
            </button>
        </div>

        <div id="ranking-container">
            <p class="text-center p-8 text-lg text-gray-700">Carregando dados do ranking...</p>
        </div>

        <div id="error-message" class="text-center p-8 text-lg text-red-600 hidden">
            <p>Ocorreu um erro ao carregar os dados. Por favor, tente novamente mais tarde.</p>
        </div>
    </div>

    <!-- O script do Supabase agora é importado como um módulo abaixo -->
    <script type="module">
        // Importa createClient diretamente da biblioteca Supabase como um módulo ES
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.50.0/+esm';

        // Garante que o script só seja executado após o DOM estar completamente carregado
        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase configuration
            const SUPABASE_URL = "https://xwejzglvqsiydycvivys.supabase.co";
            // CRITICAL SECURITY WARNING:
            // The provided key is a 'service_role' key, which MUST NOT be exposed on the frontend.
            // It has full access to your database. For production use, please use your
            // PUBLIC (anon) Supabase key. The public key can be found in your
            // Supabase dashboard under "Settings" -> "API".
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZWp6Z2x2cXNpeWR5Y3ZpdnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIyNDgzOTQsImV4cCI6MjA1NzgyNDM5NH0.32ClzsWEgc_XdqXD4d8i7_AO4SOIjKjzQCPb_SjJBoU";

            // Initialize the Supabase client
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Estado de ordenação atual
            let currentSort = {
                column: 'position', // Coluna padrão para ordenar
                ascending: true     // Direção padrão (ascendente)
            };

            async function fetchRanking(orderByColumn = currentSort.column, ascending = currentSort.ascending) {
                const rankingContainer = document.getElementById('ranking-container');
                const errorMessage = document.getElementById('error-message');

                rankingContainer.innerHTML = '<p class="text-center p-8 text-lg text-gray-700">Carregando dados do ranking...</p>';
                errorMessage.classList.add('hidden');

                try {
                    // Update the query to include necessary columns, filter out null hosts, and apply ordering
                    const { data, error } = await supabase
                        .from('competitors')
                        .select('room_id, title, host, position, total_reviews, score, price, host_link, scrap_url, host(url, name)')
                        .not('host', 'is', null) // Filter: remove rows where 'host' is null
                        .order(orderByColumn, { ascending: ascending });

                    if (error) {
                        console.error('Erro ao buscar dados:', error.message);
                        rankingContainer.classList.add('hidden');
                        errorMessage.classList.remove('hidden');
                        return;
                    }

                    if (!data || data.length === 0) {
                        rankingContainer.innerHTML = '<p class="text-center p-8 text-lg text-gray-700">Nenhum dado de ranking encontrado.</p>';
                        return;
                    }

                    // Create the HTML table
                    let tableHtml = `
                        <div class="overflow-x-auto rounded-xl shadow-md">
                            <table class="w-full text-left border-separate border-spacing-0 rounded-xl overflow-hidden">
                                <thead class="bg-indigo-600 text-white text-sm uppercase">
                                    <tr>
                                        <th class="py-3 px-4 rounded-tl-xl font-semibold"></th> <!-- Empty header for position -->
                                        <th class="py-3 px-4 font-semibold">Host</th>
                                        <th class="py-3 px-4 font-semibold">Room ID</th>
                                        <th class="py-3 px-4 font-semibold">Título</th>
                                        <th class="py-3 px-4 font-semibold">Avaliações</th>
                                        <th class="py-3 px-4 font-semibold">Preço</th>
                                        <th class="py-3 px-4 rounded-tr-xl font-semibold"></th> <!-- Empty header for Conteúdo -->
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    data.forEach((competitor, index) => {
                        const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-indigo-50';
                        const imageUrl = competitor.host && competitor.host.url ? competitor.host.url : 'https://placehold.co/40x40/cccccc/333333?text=N/A'; // Fallback image
                        const hostName = competitor.host && competitor.host.name ? competitor.host.name : 'N/A'; // Host name
                        const price = competitor.price !== null ? `R$ ${competitor.price.toFixed(2)}` : 'N/A'; // Format price
                        const hostLink = competitor.host_link ? competitor.host_link : '#'; // Host link, fallback to '#'
                        
                        let scrapUrl = competitor.scrap_url ? competitor.scrap_url : '#'; // Scrap URL, fallback to '#'
                        // Ensure scrapUrl starts with https://
                        if (scrapUrl !== '#' && !scrapUrl.startsWith('https://') && !scrapUrl.startsWith('http://')) {
                            scrapUrl = `https://${scrapUrl}`;
                        }


                        // Combine score and total_reviews for display
                        const scoreDisplay = competitor.score !== null ? competitor.score.toFixed(2) : 'N/A';
                        const totalReviewsDisplay = competitor.total_reviews !== null ? competitor.total_reviews : 'N/A';
                        const reviewsCombined = `${scoreDisplay} (${totalReviewsDisplay})`;

                        tableHtml += `
                            <tr class="${rowBg} border-b border-gray-200 last:border-b-0">
                                <td class="py-3 px-4">${competitor.position}</td>
                                <td class="py-3 px-4">
                                    <a href="${hostLink}" target="_blank" class="flex items-center space-x-2 text-indigo-600 hover:text-indigo-800 hover:underline">
                                        <img src="${imageUrl}" alt="Host Image" class="w-10 h-10 rounded-full object-cover">
                                        <span>${hostName}</span>
                                    </a>
                                </td>
                                <td class="py-3 px-4">${competitor.room_id}</td>
                                <td class="py-3 px-4">${competitor.title}</td>
                                <td class="py-3 px-4">${reviewsCombined}</td>
                                <td class="py-3 px-4">${price}</td>
                                <td class="py-3 px-4 text-center">
                                    ${scrapUrl !== '#' ? `
                                        <a href="${scrapUrl}" target="_blank" class="inline-block text-indigo-600 hover:text-indigo-800">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                            </svg>
                                        </a>
                                    ` : 'N/A'}
                                </td>
                            </tr>
                        `;
                    });

                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    rankingContainer.innerHTML = tableHtml;
                } catch (err) {
                    console.error('Erro inesperado:', err);
                    rankingContainer.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }

            // Função para lidar com a ordenação
            function handleSort(column) {
                if (currentSort.column === column) {
                    currentSort.ascending = !currentSort.ascending; // Alterna a direção se a mesma coluna for clicada
                } else {
                    currentSort.column = column;
                    currentSort.ascending = true; // Define a nova coluna e padrão para ascendente
                }
                fetchRanking(); // Chama a função para buscar e reordenar os dados
            }

            // Adiciona event listeners aos botões de ordenação
            document.getElementById('sort-position').addEventListener('click', () => handleSort('position'));
            document.getElementById('sort-host').addEventListener('click', () => handleSort('host')); 
            document.getElementById('sort-price').addEventListener('click', () => handleSort('price'));

            // Chama a função para buscar os dados quando o DOM estiver carregado
            fetchRanking();
        });
    </script>
</body>
</html>
