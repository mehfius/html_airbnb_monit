<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Hospedagens Disponíveis em Taperapuã</title>
    <!-- Inclui o Tailwind CSS do CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração do Tailwind para a fonte Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        /* Custom styles for rounded table corners */
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        th, td {
            border-bottom: 1px solid #e2e8f0; /* light gray */
        }
        tr:last-child td {
            border-bottom: none;
        }
        thead th:first-child {
            border-top-left-radius: 0.75rem; /* rounded-tl-xl */
        }
        thead th:last-child {
            border-top-right-radius: 0.75rem; /* rounded-tr-xl */
        }
        tbody tr:last-child td:first-child {
            border-bottom-left-radius: 0.75rem; /* rounded-bl-xl */
        }
        tbody tr:last-child td:last-child {
            border-bottom-right-radius: 0.75rem; /* rounded-br-xl */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="font-inter bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl w-full bg-white shadow-lg rounded-xl p-6 sm:p-8 lg:p-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-indigo-700">Lista de Hospedagens Disponíveis em Taperapuã</h1>
        <!-- Texto explicativo para a coluna Posição -->
        <p class="text-center text-sm text-gray-600 mb-6">
            A coluna de Posição indica a ordem de exibição das hospedagens.
        </p>

        <!-- Navegação de Datas -->
        <div class="flex items-center justify-center gap-4 mb-6">
            <button id="prev-day" class="px-3 py-1 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                &lt; Anterior
            </button>
            <span id="current-date-display" class="text-xl font-bold text-indigo-800"></span> <!-- Made font-bold for prominence -->
            <button id="next-day" class="px-3 py-1 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-300 ease-in-out">
                Próximo &gt;
            </button>
        </div>

        <div id="ranking-container">
            <p class="text-center p-8 text-lg text-gray-700">Carregando dados...</p>
        </div>

        <div id="error-message" class="text-center p-8 text-lg text-red-600 hidden">
            <p>Ocorreu um erro ao carregar os dados. Por favor, tente novamente mais tarde.</p>
        </div>
    </div>

    <!-- O script do Supabase agora é importado como um módulo abaixo -->
    <script type="module">
        // Import createClient directly from the Supabase ES module
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.50.0/+esm';

        // Ensure the script runs only after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async () => {
            // Supabase configuration
            const SUPABASE_URL = "https://xwejzglvqsiydycvivys.supabase.co";
            // POR FAVOR, SUBSTITUA ESTE VALOR PELA SUA CHAVE PÚBLICA (ANON) DO SUPABASE.
            // VOCÊ PODE ENCONTRÁ-LA NO SEU PAINEL DO SUPABASE EM "SETTINGS" -> "API".
            // NUNCA EXPONHA SUA CHAVE 'service_role' NO FRONTEND!
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3ZWp6Z2x2cXNpeWR5Y3ZpdnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIyNDgzOTQsImV4cCI6MjA1NzgyNDM5NH0.32ClzsWEgc_XdqXD4d8i7_AO4SOIjKjzQCPb_SjJBoU"; 

            // Initialize the Supabase client
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Current date being displayed for filtering
            let currentDate = new Date(); // Initialize with today's date
            currentDate.setDate(currentDate.getDate() + 1); // Set to tomorrow's date

            // Helper function to format a Date object as DD/MM/YYYY for display
            function formatDateForDisplay(dateObj) {
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const year = dateObj.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Helper function to format a Date object as YYYY-MM-DD for Supabase query
            function formatDateForSupabase(dateObj) {
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Function to fetch and render ranking data for a specific date
            async function fetchRankingsForDate(dateToFetch) {
                const rankingContainer = document.getElementById('ranking-container');
                const errorMessage = document.getElementById('error-message');
                const dateDisplay = document.getElementById('current-date-display');

                rankingContainer.innerHTML = '<p class="text-center p-8 text-lg text-gray-700">Carregando dados...</p>';
                errorMessage.classList.add('hidden');
                dateDisplay.textContent = formatDateForDisplay(dateToFetch); // Update date display immediately

                try {
                    // Format the date for the Supabase query
                    const formattedDate = formatDateForSupabase(dateToFetch);

                    // Fetch data from Supabase, filtering by 'checkin' date directly in the query
                    // Re-added 'scrap_url' to the select statement, but NOT 'room_id'
                    const { data, error } = await supabase
                        .from('frontend')
                        .select('name, title, price, position, room_image_array, host_image, checkin, scrap_url')
                        .eq('checkin', formattedDate) // Filter by exact checkin date
                        .order('position', { ascending: true }) // Always order by position
                        .limit(10); // Limit to a maximum of 10 results per date

                    if (error) {
                        console.error('Erro ao buscar dados:', error.message);
                        rankingContainer.classList.add('hidden');
                        errorMessage.classList.remove('hidden');
                        return;
                    }

                    if (!data || data.length === 0) {
                        rankingContainer.innerHTML = `<p class="text-center p-8 text-lg text-gray-700">Nenhuma hospedagem encontrada para a data: <strong>${formatDateForDisplay(dateToFetch)}</strong>. Tente navegar para outras datas.</p>`;
                        return;
                    }

                    renderTable(data); // Render the table with the fetched data
                } catch (err) {
                    console.error('Erro inesperado:', err);
                    rankingContainer.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }

            // Function to render the HTML table
            function renderTable(data) {
                const rankingContainer = document.getElementById('ranking-container');
                let tableHtml = `
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="w-full text-left border-separate border-spacing-0 rounded-xl overflow-hidden">
                            <thead class="bg-indigo-600 text-white text-sm uppercase">
                                <tr>
                                    <th class="py-3 px-4 rounded-tl-xl font-semibold"></th> <!-- Removed "Posição" label -->
                                    <th class="py-3 px-4 font-semibold">Host</th>
                                    <th class="py-3 px-4 font-semibold">Título</th>
                                    <th class="py-3 px-4 font-semibold">Data</th> 
                                    <th class="py-3 px-4 text-right font-semibold">Preço</th>
                                    <th class="py-3 px-4 rounded-tr-xl font-semibold text-center">Link</th> <!-- Renamed column header to "Link" -->
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.forEach((competitor, index) => {
                    const rowBg = index % 2 === 0 ? 'bg-white' : 'bg-indigo-50';
                    
                    const hostImage = competitor.host_image ? competitor.host_image : '';
                    const hostName = competitor.name ? competitor.name : 'Nome não disponível';
                    const price = competitor.price !== null ? `R$ ${Math.round(competitor.price)}` : ''; 
                    const checkinDate = competitor.checkin ? formatDateForDisplay(new Date(competitor.checkin + 'T12:00:00')) : ''; 
                    const roomImage = (competitor.room_image_array && competitor.room_image_array.length > 0) 
                                      ? competitor.room_image_array[0] 
                                      : `https://placehold.co/50x50/cccccc/000000?text=No+Image`; 
                    
                    const scrapUrl = competitor.scrap_url ? competitor.scrap_url : '#'; // Use scrap_url
                    
                    tableHtml += `
                        <tr class="${rowBg} border-b border-gray-200 last:border-b-0">
                            <td class="py-3 px-4">${competitor.position !== null ? competitor.position : ''}</td>
                            <td class="py-3 px-4 relative group">
                                ${hostImage ? `<img src="${hostImage}" alt="Host Image" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/40x40/cccccc/000000?text=Host';">` : ''}
                                <!-- Tooltip for host name -->
                                <span class="absolute left-1/2 bottom-full mb-2 -translate-x-1/2 
                                              bg-gray-800 text-white text-xs p-1 rounded-md opacity-0 
                                              group-hover:opacity-100 transition-opacity duration-200 
                                              whitespace-nowrap z-10">
                                    ${hostName}
                                </span>
                            </td>
                            <td class="py-3 px-4 flex items-center space-x-3">
                                ${roomImage ? `<a href="${roomImage}" target="_blank"><img src="${roomImage}" alt="Room Image" class="w-16 h-12 object-cover rounded-md shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/000000?text=No+Image';"></a>` : ''}
                                <span class="flex-grow">${competitor.title !== null ? competitor.title : ''}</span>
                            </td>
                            <td class="py-3 px-4">${checkinDate}</td> 
                            <td class="py-3 px-4 text-right whitespace-nowrap">${price}</td>
                            <td class="py-3 px-4 text-center relative group">
                                ${scrapUrl !== '#' ? `
                                    <a href="${scrapUrl}" target="_blank" class="inline-block text-indigo-600 hover:text-indigo-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                        </svg>
                                        <span class="absolute left-1/2 bottom-full mb-2 -translate-x-1/2 
                                                      bg-gray-800 text-white text-xs p-1 rounded-md opacity-0 
                                                      group-hover:opacity-100 transition-opacity duration-200 
                                                      whitespace-nowrap z-10">
                                            Ver Detalhes
                                        </span>
                                    </a>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });

                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                rankingContainer.innerHTML = tableHtml;
            }

            // Event listeners for date navigation
            document.getElementById('prev-day').addEventListener('click', () => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() - 1);
                currentDate = newDate; // Update the global currentDate
                fetchRankingsForDate(currentDate);
            });

            document.getElementById('next-day').addEventListener('click', () => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + 1);
                currentDate = newDate; // Update the global currentDate
                fetchRankingsForDate(currentDate);
            });

            // Initial fetch of data for the starting date (tomorrow)
            fetchRankingsForDate(currentDate);
        });
    </script>
</body>
</html>
